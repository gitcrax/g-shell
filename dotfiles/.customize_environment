#!/bin/bash
#
# .customize_environment
#
# This script is executed as root by Google Cloud Shell on every startup.
# It restores the user's desired "System State" from the persistent repo.

# The USER_HOME variable is injected by the parent script.
# This is a fallback for safety.
USER_HOME="${1:-$(getent passwd "${SUDO_USER:-$USER}" | cut -d: -f6)}"
SOURCE_REPO="${USER_HOME}/g-shell"

exec > "${USER_HOME}/customize_environment.log" 2>&1
set -x # Enable verbose logging

# Ensure the script runs non-interactively
export DEBIAN_FRONTEND=noninteractive

# --- 1. System Package Restoration ---
# Installs packages listed in packages/apt.list

APT_LIST="${SOURCE_REPO}/packages/apt.list"

if [ -f "$APT_LIST" ]; then
    echo "Updating apt cache..."
    sudo apt-get update

    # Read the file, filtering out comments and empty lines
    PACKAGES=$(grep -vE '^\s*#|^\s*$' "$APT_LIST" | tr '\n' ' ')
    
    if [ -n "$PACKAGES" ]; then
        echo "Installing persistent packages: $PACKAGES"
        # shellcheck disable=SC2086
        sudo apt-get install -y $PACKAGES
    else
        echo "No packages found in apt.list."
    fi
else
    echo "Warning: Package list not found at $APT_LIST"
fi

# --- 2. Root File System Overlay ---
# Copies any config files from root_overlay/ to /

OVERLAY_DIR="${SOURCE_REPO}/root_overlay"

if [ -d "$OVERLAY_DIR" ]; then
    echo "Applying root overlay from $OVERLAY_DIR..."
    # cp -R does a recursive copy.
    # The ending / on source ensures we copy contents, not the dir itself.
    sudo cp -Rv "${OVERLAY_DIR}/." /
    echo "Root overlay applied."

    # --- 2.1 Persistent Docker Setup (Bind Mount) ---
    # This approach is the most reliable in Cloud Shell environments.
    # It maps your persistent home directory directly into Docker's internal path.
    DOCKER_PERSIST_DIR="${USER_HOME}/.docker_root"
    DOCKER_SYSTEM_DIR="/var/lib/docker"

    echo "Ensuring persistent Docker storage at ${DOCKER_PERSIST_DIR}..."
    mkdir -p "${DOCKER_PERSIST_DIR}"

    echo "Stopping Docker to swap data directory..."
    sudo systemctl stop docker.socket || true
    sudo systemctl stop docker || true

    # Only mount if not already mounted
    if ! mountpoint -q "${DOCKER_SYSTEM_DIR}"; then
        echo "Mounting ${DOCKER_PERSIST_DIR} to ${DOCKER_SYSTEM_DIR}..."
        # We must clear the system dir first to avoid merging issues
        sudo rm -rf "${DOCKER_SYSTEM_DIR}"/*
        sudo mount --bind "${DOCKER_PERSIST_DIR}" "${DOCKER_SYSTEM_DIR}"
    fi

    echo "Starting Docker service..."
    sudo systemctl start docker
    echo "Docker persistence initialized via bind-mount."
else
    echo "No root_overlay directory found. Skipping."
fi

# --- 3. Binary Restorations ---
# For things that need manual dpkg install (like Fastfetch)

# Install Fastfetch from local deb if exists
if [ -f "${USER_HOME}/.local/share/debs/fastfetch.deb" ]; then
    if ! command -v fastfetch >/dev/null 2>&1; then
        echo "Installing Fastfetch..."
        sudo dpkg -i "${USER_HOME}/.local/share/debs/fastfetch.deb"
        sudo apt-get install -f -y
    fi
fi

source ~/.bashrc
